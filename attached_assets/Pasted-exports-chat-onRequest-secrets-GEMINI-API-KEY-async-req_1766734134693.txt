exports.chat = onRequest(
  { secrets: [GEMINI_API_KEY] },
  async (req, res) => {
    corsHandler(req, res, async () => {
      try {
        if (req.method !== "POST") {
          return res.status(405).json({ error: "Method not allowed" });
        }

        const message = req.body?.message;
        const sessionId = req.body?.sessionId;
        const businessId =
          req.body?.businessId || req.headers["x-business-id"];

        if (!message) {
          return res.status(400).json({ error: "Message is required" });
        }

        if (!businessId) {
          return res.status(400).json({
            error: "businessId is required"
          });
        }

        /* ---------- Load business ---------- */
        const ref = db.collection("businesses").doc(businessId);
const businessSnap = await ref.get();

console.log("BUSINESS DOC PATH:", ref.path);
console.log("BUSINESS RAW EXISTS:", businessSnap.exists);
console.log("BUSINESS RAW DATA:", JSON.stringify(businessSnap.data(), null, 2));

if (!businessSnap.exists) {
  return res.status(404).json({ error: "Business not found" });
}

const business = businessSnap.data();


        /* ---------- Session ---------- */
        const sid = sessionId || crypto.randomUUID();
        const sessionRef = db.collection("chat_sessions").doc(sid);

        let history = [];
        const sessionSnap = await sessionRef.get();
        if (sessionSnap.exists) {
          history = sessionSnap.data().messages || [];
        }

        history.push({ role: "user", text: message });
        history = history.slice(-MAX_HISTORY);

        const contents = history.map(m => ({
          role: m.role === "model" ? "model" : "user",
          parts: [{ text: m.text }]
        }));

        /* ---------- Prompt ---------- */
        const today = new Date().toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric"
        });

        const servicesText = (business.context?.services || []).join(", ");
        const rulesText = (business.context?.rules || [])
          .map(r => `- ${r}`)
          .join("\n");

        const voice = business.voice || {};

        const systemPrompt = `
You are the AI voice assistant for ${business.businessName || "this business"}.

Business description:
${business.context?.description || "No description provided."}

Services:
${servicesText || "Not specified"}

Business hours:
${business.context?.hours || "Not specified"}

Rules:
${rulesText || "No special rules"}

Voice & tone:
Speak in a calm, friendly, and professional manner.
Keep responses meaningful and conversational.
Preferred language: ${voice.language || "en-US"}.

Today is ${today}.
        `.trim();

        /* ---------- Gemini call ---------- */
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY.value()}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              systemInstruction: {
                parts: [{ text: systemPrompt }]
              },
              contents,
              generationConfig: {
                maxOutputTokens: 150,
                temperature: 0.6
              }
            })
          }
        );

        const data = await response.json();

        const reply =
          data?.candidates?.[0]?.content?.parts?.[0]?.text ||
          "Sorry, I didnâ€™t catch that. Could you repeat it?";

        history.push({ role: "model", text: reply });
        history = history.slice(-MAX_HISTORY);

        await sessionRef.set(
          {
            businessId,
            messages: history,
            updatedAt: admin.firestore.FieldValue.serverTimestamp()
          },
          { merge: true } 
        );
        

        /* ---------- Return ---------- */
        res.json({
          reply,
          sessionId: sid,
          widget: {
            logoUrl: business.widget?.logoUrl || null,
            theme: business.widget?.theme || { mode: "dark" },
            voice: {
              language: voice.language || "en-US",
              gender: voice.gender || "female",
              rate: voice.rate || 1,
              pitch: voice.pitch || 1
            }
          }
        });

      } catch (err) {
        console.error("Chat error:", err);
        res.status(500).json({ error: "Internal server error" });
      }
    });
  }
);